{"id": "d789cb8a-267c-4822-80a4-a0135ce3f40e", "text": "Q: Spring Hibernate Multitenancy A: <h3>How to write bypassing tenant isolation.</h3>\n<p>We can mark the tenant (or tenants) of the superadmins as a root tenant.\nIn your implementation of the <code>CurrentTenantIdentifierResolver</code>, implement the method <code>isRoot</code>:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Override\npublic boolean isRoot(UUID tenantId) {\nreturn DEFAULT_TENANT_CODE.equals(tenantId);\n}\n</code></pre>\n<p>We need to set <code>tenantId</code> on the <code>article</code> explicitly. Hibernate will not ignore changes to <code>tenantId</code> when the current tenant is root.</p>\n<pre class=\"lang-java prettyprint-override\"><code>newArticle.setTenantId(targetTenantId);\nArticle article = articleRepository.save(newArticle);\n</code></pre>\n<p>Later, however, when the ordinary tenant tries to read the creator of the article, an <code>EntityNotFoundException</code> will be thrown.  We need to bypass tenant isolation while reading the <code>createdBy</code> field, as below.</p>\n<h3>How to read bypassing tenant isolation.</h3>\n<p>We can map the <code>user_</code> table the second time, this time as an immutable entity <code>UserForAudit</code>.</p>\n<p>I assume you already have table <code>user_</code> mapped to entity <code>User</code>.</p>\n<p><code>UserForAudit</code> does not have any field marked with @TenantId, so it will bypass tenant isolation and load the username of the creator.</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Entity\n@Table(name = &quot;user_&quot;)\n@Immutable\n@Getter\npublic class UserForAudit {\n  @Id\n  private UUID id;\n  private String username;\n\n  public static UserForAudit fromUser(User user) {\n    return new UserForAudit(user.getId(), user.getUsername());\n  }\n}\n</code></pre>\n<p>Parameterize your <code>AuditorAware</code> with <code>UserForAudit</code> instead of <code>User</code>. Retrieve a <code>User</code> from the security context, but convert it into <code>UserForAudit</code>.</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Component\npublic class SpringSecurityAuditorAware implements AuditorAware&lt;UserForAudit&gt; {\n  @Override\n  public Optional&lt;UserForAudit&gt; getCurrentAuditor() {\n    return Optional.ofNullable(SecurityContextHolder.getContext())\n        .map(SecurityContext::getAuthentication)\n        .filter(Authentication::isAuthenticated)\n        .map(Authentication::getPrincipal)\n        .map(User.class::cast)\n        .map(UserForAudit::fromUser);\n  }\n}\n</code></pre>\n<p>Reference it in your <code>Article</code> entity instead of <code>User</code>:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Entity\n@EntityListeners(AuditingEntityListener.class)\n  public class Article {\n  //..\n  @CreatedBy\n  @ManyToOne\n  @JoinColumn(name = &quot;created_by&quot;)\n  private UserForAudit createdBy;\n}\n</code></pre>\n", "tags": ["java", "spring", "spring-boot", "hibernate", "multi-tenant"]}
{"id": "d7012ea8-91b9-4ade-95ef-8b29faa11ab1", "text": "Q: Syntax match issue with lookahead (regex \\@=) A: <p>Nothing is broken \u2014 this is just how Vim\u2019s syntax highlighting works.</p>\n<p><code>\\@=</code> is a zero-width lookahead: it matches a pattern without consuming characters. But in <code>:syn match</code>, Vim highlights the entire pattern, even the part used only for the lookahead. That\u2019s why <code>(\\+\\s)\\@=\\w+</code> highlights the <code>+ </code>even though it\u2019s not \u201cconsumed.\u201d</p>\n<p>Using <code>\\zs</code> changes the start of the highlighted match, which is why <code>(\\+\\s)\\zs\\w+</code> behaves as expected.  So:</p>\n<p><code>\\@=</code> controls matching, not highlighting</p>\n<p><code>\\zs</code> / <code>\\ze</code> control the highlight boundaries for syntax</p>\n<p>This is normal Vim behavior, not a regex bug</p>\n", "tags": ["vim", "syntax", "match"]}
{"id": "644ed1b1-41eb-4f2b-baee-d24c057cc080", "text": "Q: Multithreading becomes much slower than multiprocessing in free-threaded Python A: <p>I didn't investigate the code deeply enough, but you could give a try to sprinkle some <a href=\"https://dpdani.github.io/cereggii/api/ThreadHandle/\" rel=\"nofollow noreferrer\"><code>ThreadHandle</code></a>s on top of your code to see if you can avoid the bottleneck. Probably you would do something like this?</p>\n<pre class=\"lang-py prettyprint-override\"><code>def worker(group, n_loop):\n    return sum(kernel(ThreadHandle(g), n_loop) for g in group)\n</code></pre>\n<p>But again, I haven't thoroughly checked your code and I might be missing some other bottleneck. The tricky part to this reference counting contention problems is that you need to remove all of them before you see an actual speedup. (Because the lesser contention on one object may result in greater contention on another object.)</p>\n<p>Full disclosure: I maintain that library.</p>\n", "tags": ["python", "python-3.x", "multithreading", "multiprocessing"]}
{"id": "02333aaf-486a-41ab-8ff4-3467ecbcc9be", "text": "Q: Prometheus - shorten a label A: <p>It's not working because your regex isn't matching, you need something like this</p>\n<pre><code>&quot;(.{12}).*&quot;\n</code></pre>\n<p>The <code>.*</code> matches everything after the first 12 char but it's not in the capture group so it's not in <code>$1</code></p>\n", "tags": ["prometheus"]}
{"id": "993f0f35-39d6-4b18-835e-3abd03303b6f", "text": "Q: How to speed-up the Ipopt solver? A: <p><a href=\"https://opty.readthedocs.io/\" rel=\"nofollow noreferrer\">opty</a> is a Python package designed for solving such problems which utilizes cyipopt in the background. This script solves your stated problem:</p>\n<pre class=\"lang-py prettyprint-override\"><code>import numpy as np\nimport sympy as sm\nimport matplotlib.pyplot as plt\nfrom opty import Problem, create_objective_function\n\nt = sm.symbols('t', real=True)\nx1, x2, v = sm.Function('x1')(t), sm.Function('x2')(t), sm.Function('v')(t)\n\neqs = sm.Matrix([x1.diff() - x1 + x1*x2 + 0.4*x1*v,\n                 x2.diff() + x2 - x1*x2 + 0.2*x2*v])\nbounds = {v: (0.0, 1.0)}\ninstance = (x1.func(0.0) - 0.5, x2.func(0.0) - 0.7)\n\nduration = 12.0\nnum_nodes = 48\nh = duration/(num_nodes - 1)\n\nobj_func = sm.Integral((x1 - 1)**2 + (x2 - 1)**2, t)\nobj, obj_grad = create_objective_function(\n    obj_func,\n    (x1, x2),\n    (v,),\n    tuple(),\n    num_nodes,\n    h,\n    time_symbol=t,\n)\n\np = Problem(\n    obj,\n    obj_grad,\n    eqs,\n    (x1, x2),\n    num_nodes,\n    h,\n    instance_constraints=instance,\n    bounds=bounds,\n    time_symbol=t,\n)\n\nsol, info = p.solve(np.ones(p.num_free))\n\np.plot_trajectories(sol)\n\nplt.show()\n</code></pre>\n<p>With this Ipopt output:</p>\n<pre class=\"lang-none prettyprint-override\"><code>******************************************************************************\nThis program contains Ipopt, a library for large-scale nonlinear optimization.\n Ipopt is released as open source code under the Eclipse Public License (EPL).\n         For more information visit https://github.com/coin-or/Ipopt\n******************************************************************************\n\nThis is Ipopt version 3.14.16, running with linear solver MUMPS 5.7.3.\n\nNumber of nonzeros in equality constraint Jacobian...:      472\nNumber of nonzeros in inequality constraint Jacobian.:        0\nNumber of nonzeros in Lagrangian Hessian.............:        0\n\nTotal number of variables............................:      144\n                     variables with only lower bounds:        0\n                variables with lower and upper bounds:       48\n                     variables with only upper bounds:        0\nTotal number of equality constraints.................:       96\nTotal number of inequality constraints...............:        0\n        inequality constraints with only lower bounds:        0\n   inequality constraints with lower and upper bounds:        0\n        inequality constraints with only upper bounds:        0\n\niter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls\n   0  0.0000000e+00 5.00e-01 0.00e+00   0.0 0.00e+00    -  0.00e+00 0.00e+00   0\n   1  2.5533607e+00 2.12e-01 5.00e-01  -0.8 6.86e-01    -  9.94e-01 1.00e+00f  1\n   2  2.6240420e+00 4.27e-02 3.00e-01  -1.4 5.62e-01    -  9.96e-01 1.00e+00h  1\n\n  59  9.3874787e-01 3.10e-13 4.85e-08 -11.0 3.85e-06    -  1.00e+00 1.00e+00h  1\niter    objective    inf_pr   inf_du lg(mu)  ||d||  lg(rg) alpha_du alpha_pr  ls\n  60  9.3874787e-01 1.04e-15 1.04e-07 -11.0 7.91e-06    -  1.00e+00 1.00e+00H  1\n  61  9.3874787e-01 9.44e-16 1.43e-07 -11.0 2.49e-06    -  1.00e+00 1.00e+00H  1\n  62  9.3874787e-01 3.81e-13 8.38e-08 -11.0 2.51e-06    -  1.00e+00 1.00e+00h  1\n  63  9.3874787e-01 3.80e-13 7.04e-08 -11.0 3.46e-06    -  1.00e+00 1.00e+00h  1\n  64  9.3874787e-01 3.34e-13 2.08e-08 -11.0 3.00e-06    -  1.00e+00 1.00e+00h  1\n  65  9.3874787e-01 3.36e-14 2.04e-08 -11.0 6.08e-07    -  1.00e+00 1.00e+00h  1\n\nNumber of Iterations....: 65\n\n                                   (scaled)                 (unscaled)\nObjective...............:   9.3874786561073265e-01    9.3874786561073265e-01\nDual infeasibility......:   2.0377900151798790e-08    2.0377900151798790e-08\nConstraint violation....:   3.3574995201061074e-14    3.3574995201061074e-14\nVariable bound violation:   9.9616602693951356e-09    9.9616602693951356e-09\nComplementarity.........:   1.0000000000000114e-11    1.0000000000000114e-11\nOverall NLP error.......:   2.0377900151798790e-08    2.0377900151798790e-08\n\n\nNumber of objective function evaluations             = 80\nNumber of objective gradient evaluations             = 66\nNumber of equality constraint evaluations            = 80\nNumber of inequality constraint evaluations          = 0\nNumber of equality constraint Jacobian evaluations   = 66\nNumber of inequality constraint Jacobian evaluations = 0\nNumber of Lagrangian Hessian evaluations             = 0\nTotal seconds in IPOPT                               = 0.304\n\nEXIT: Solved To Acceptable Level.\n</code></pre>\n<p>And this final plot:</p>\n<p><a href=\"https://i.sstatic.net/513m0lxH.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/513m0lxH.png\" alt=\"final plot\" /></a></p>\n<p>The Ipopt functions are efficient:</p>\n<pre class=\"lang-none prettyprint-override\"><code>In [3]: %timeit obj(sol)\n8.56 \u03bcs \u00b1 38.5 ns per loop (mean \u00b1 std. dev. of 7 runs, 100,000 loops each)\n\nIn [4]: %timeit obj_grad(sol)\n15 \u03bcs \u00b1 229 ns per loop (mean \u00b1 std. dev. of 7 runs, 100,000 loops each)\n\nIn [5]: %timeit p.constraints(sol)\n15.4 \u03bcs \u00b1 244 ns per loop (mean \u00b1 std. dev. of 7 runs, 100,000 loops each)\n\nIn [6]: %timeit p.jacobian(sol)\n15.7 \u03bcs \u00b1 208 ns per loop (mean \u00b1 std. dev. of 7 runs, 100,000 loops each)\n</code></pre>\n", "tags": ["python", "numpy", "mathematical-optimization", "ipopt", "cyipopt"]}
{"id": "00898f98-4a04-4629-adea-4bf9a3ef8062", "text": "Q: IntelliJ IDEA - No compiler is provided in this environment. Perhaps you are running on a JRE rather than a JDK? A: <p>I was facing similar error while workspace setup on a new MAC system.</p>\n<p>I was initially referring <strong><code>&quot;/Library/Internet Plug-Ins/JavaAppletPlugin.plugin/Contents/Home/bin&quot;</code></strong> as JAVA_HOME path but it was not correct.</p>\n<p>The correct JDK path was <strong><code>&quot;/Library/Java/JavaVirtualMachines/jdk1.8.0_331.jdk/Contents/Home&quot;</code></strong>. If you JDK with default installation path on MAC then cross check your <strong><code>JAVA_HOME</code></strong>. It might help you to solve your problem.</p>\n", "tags": ["macos", "maven", "intellij-idea"]}
