{"id": "3c825502-9daf-44b2-b094-8957a52a3de3", "text": "Q: Deserialization via Newtonsoft for classes with a reference loop, private constructors and private/internal properties setters A: <p>Your situation is as follows:</p>\n<ol>\n<li><p>You have a bunch of types that have private, parameterized constructors and private/internal properties setters.</p>\n</li>\n<li><p>Those same types can be created via known public static factory methods.</p>\n</li>\n<li><p>They participate in polymorphic type hierarchies as well as cyclic object graphs, so you need to support both <code>TypeNameHandling.All</code> and <code>PreserveReferencesHandling.Objects</code>.</p>\n</li>\n<li><p>Newtonsoft does not support <code>PreserveReferencesHandling</code> for objects with parameterized constructors as stated in <a href=\"https://www.newtonsoft.com/json/help/html/PreserveObjectReferences.htm\" rel=\"nofollow noreferrer\">Preserving Object References</a></p>\n<blockquote>\n<p>References cannot be preserved when a value is set via a non-default constructor. With a non-default constructor, child values must be created before the parent value so they can be passed into the constructor, making tracking reference impossible.</p>\n</blockquote>\n</li>\n</ol>\n<p>Given these requirements, I suggest to create a custom <a href=\"https://www.newtonsoft.com/json/help/html/contractresolver.htm#CustomIContractResolverExamples\" rel=\"nofollow noreferrer\">contract <code>DefaultContractResolver</code></a> as follows:</p>\n<ol>\n<li><p>It takes a list of known types with known static factory methods and injects them as <strong>parameterless</strong> creator methods by passing default values for their arguments.</p>\n<p>By injecting a parameterless creator method you enable <code>PreserveReferencesHandling</code>.</p>\n</li>\n<li><p>It marks the private and internal property setters as public.</p>\n</li>\n</ol>\n<p>Putting that together, your custom resolver should look like:</p>\n<pre class=\"lang-cs prettyprint-override\"><code>public class CreatorFactoryContractResolver : DefaultContractResolver\n{\n    readonly Dictionary&lt;Type, Func&lt;object&gt;&gt; creators;\n    \n    public CreatorFactoryContractResolver(IEnumerable&lt;KeyValuePair&lt;Type, Func&lt;object&gt;&gt;&gt; creators)\n    {\n        // Since DefaultContractResolver caches its contracts we need to snapshot the dictionary to avoid bugs with subsequent mutation\n        this.creators = creators.ToDictionary(p =&gt; p.Key, p =&gt; p.Value);\n    }\n\n    protected override JsonContract CreateContract(Type type)\n    {\n        if (creators.ContainsKey(type))\n            // Avoid calling CreateContract() in case the type implements ISerializable \n            return CreateObjectContract(type);\n        return base.CreateContract(type);\n    }\n    \n    protected override JsonObjectContract CreateObjectContract(Type type)\n    {\n        var contract = base.CreateObjectContract(type);\n        Func&lt;object&gt; creator;\n        if (creators.TryGetValue(type, out creator))\n            contract = InjectCreator(contract, creator);\n        return contract;\n    }\n\n    static JsonObjectContract InjectCreator(JsonObjectContract contract, Func&lt;object&gt; creator)\n    {\n        contract.DefaultCreator = creator;\n        contract.DefaultCreatorNonPublic = false;\n        contract.OverrideCreator = null;\n        if (contract.CreatorParameters != null)\n            contract.CreatorParameters.Clear();\n        return contract;\n    }\n\n    protected override JsonProperty CreateProperty(MemberInfo member, MemberSerialization memberSerialization)\n    {\n        var prop = base.CreateProperty(member, memberSerialization);\n        if (prop != null &amp;&amp; !prop.Writable &amp;&amp; creators.ContainsKey(prop.DeclaringType))\n            prop = MakeWritable(prop, member);\n        return prop;\n    }\n    \n    static JsonProperty MakeWritable(JsonProperty property, MemberInfo member)\n    {\n        if (property != null &amp;&amp; !property.Writable)\n        {\n            switch (member.MemberType)\n            {\n                case MemberTypes.Field:\n                    property.Writable = true;\n                    break;\n                case MemberTypes.Property:\n                    var hasPrivateSetter = ((PropertyInfo)member).GetSetMethod(true) != null;\n                    property.Writable = hasPrivateSetter;\n                    break;\n            }\n        }\n        return property;\n    }\n}\n</code></pre>\n<p>Then round-trip to JSON as follows:</p>\n<pre><code>var knownTypesWithCreators = new Dictionary&lt;Type, Func&lt;object&gt;&gt;()\n{\n    { typeof(Table), () =&gt; Table.CreateTable(default(int)) },\n    { typeof(Section), () =&gt; Section.CreateSection(default(int)) },\n};\n\nvar settings = new JsonSerializerSettings\n{\n    PreserveReferencesHandling = PreserveReferencesHandling.Objects,\n    TypeNameHandling = TypeNameHandling.All,\n    ConstructorHandling = ConstructorHandling.AllowNonPublicDefaultConstructor,\n    ContractResolver = new CreatorFactoryContractResolver(knownTypesWithCreators),\n};\n\nvar json = JsonConvert.SerializeObject(section, Formatting.Indented, settings);         \n\nvar restored = JsonConvert.DeserializeObject&lt;ISection&gt;(json, settings);\n</code></pre>\n<p>And your types and back-references will be preserved.</p>\n<p>Notes:</p>\n<ul>\n<li><p>This approach does require you to manually collect the types whose static factory methods should be used for deserialization.</p>\n</li>\n<li><p>It also assumes that you can pass default values to your static factory methods then later populate your objects successfully by calling nonpublic property setters.  If the property setters simply don't exist then this won't work.</p>\n</li>\n<li><p>When using <code>TypeNameHandling</code>, do take note of this caution from the <a href=\"https://www.newtonsoft.com/json/help/html/T_Newtonsoft_Json_TypeNameHandling.htm\" rel=\"nofollow noreferrer\">Newtonsoft docs</a>:</p>\n<blockquote>\n<p>TypeNameHandling should be used with caution when your application deserializes JSON from an external source. Incoming types should be validated with a custom SerializationBinder when deserializing with a value other than None.</p>\n</blockquote>\n<p>For a discussion of why this may be necessary, see <em><a href=\"https://stackoverflow.com/q/39565954\">TypeNameHandling caution in Newtonsoft Json</a></em>.</p>\n</li>\n<li><p>Newtonsoft <a href=\"https://www.newtonsoft.com/json/help/html/Performance.htm#ReuseContractResolver\" rel=\"nofollow noreferrer\">recommends</a> to cache and reuse <code>JsonSerializerSettings</code> for best performance.</p>\n</li>\n</ul>\n<p>Demo .NET Framework fiddle <a href=\"https://dotnetfiddle.net/EXPxHP\" rel=\"nofollow noreferrer\">here</a>.</p>\n", "tags": ["c#", ".net", "serialization", "json.net", "json-deserialization"]}
{"id": "058a9edd-daa2-4117-850c-36e843e10534", "text": "Q: What are the cons of using a contentEditable div rather than a textarea?  A: <p>It's not the same thing. First semantically, the purpose of a textarea is to write/edit plain text whereas with contentEditable you can edit list for instance (see: <a href=\"http://html5demos.com/contenteditable\" rel=\"nofollow noreferrer\">htmldemo</a>)\nSecond the behavior is also different. For example, in chrome when you test the link below and that you delete all the content you lose the focus (the div element disappear) which is not the expected behavior, or if it is it's idiot.</p>\n", "tags": ["javascript", "html", "css", "contenteditable"]}
{"id": "41cef644-7584-46de-8515-dc24a0eb2a3c", "text": "Q: Terminating a hung thread in a C# .NET desktop app A: <blockquote>\n<p>We have <code>Thread.Abort()</code>, but in the documentation it says it is &quot;Obsolete&quot; and &quot;not supported&quot;.</p>\n</blockquote>\n<p>Not in the <a href=\"https://learn.microsoft.com/en-us/dotnet/api/system.threading.thread.abort?view=netframework-4.8\" rel=\"nofollow noreferrer\">documentation for the .NET Framework 4.8 platform</a>. In this platform the <a href=\"https://learn.microsoft.com/en-us/dotnet/api/system.threading.thread.abort?view=netframework-4.8\" rel=\"nofollow noreferrer\"><code>Thread.Abort</code></a> is fully functional, and doesn't produce compilation warnings. So you are free to use it. There are <a href=\"https://stackoverflow.com/questions/1559255/whats-wrong-with-using-thread-abort\" title=\"What's wrong with using Thread.Abort()\">tons of reasons</a> to avoid it, and that's why it's not supported in .NET Core and later platforms, but it's up to you to judge if the benefits outvalue the risks, based on your intricate knowledge of your application.</p>\n<p>Aborting <a href=\"https://learn.microsoft.com/en-us/dotnet/api/system.threading.threadpool\" rel=\"nofollow noreferrer\"><code>ThreadPool</code></a> threads might be exceptionally risky though, because your are meddling with a core component in the .NET infrastructure. Most likely the <code>ThreadPool</code> is robust enough to survive having its threads blasted from outside, but I would prefer not to push my luck. You could consider two alternatives to killing <code>ThreadPool</code> threads:</p>\n<ol>\n<li><p>Kill non-thread-pool threads instead. You can launch a <code>Task</code> on a dedicated thread, i.e. a thread created specifically for this task and for nothing else,\nby using the <a href=\"https://learn.microsoft.com/en-us/dotnet/api/system.threading.tasks.taskcreationoptions\" rel=\"nofollow noreferrer\"><code>TaskCreationOptions.LongRunning</code></a> option:</p>\n<pre><code>Task fileTask = Task.Factory.StartNew(() =&gt;\n{\n    ProcessSingleFile(filePath, isReadFolder, token);\n}, token, TaskCreationOptions.LongRunning, TaskScheduler.Default);\n</code></pre>\n</li>\n<li><p>Don't let the threads die, and instead reset the abort (<a href=\"https://learn.microsoft.com/en-us/dotnet/api/system.threading.thread.resetabort?view=netframework-4.8\" rel=\"nofollow noreferrer\"><code>Thread.ResetAbort</code></a>) after catching the <code>ThreadAbortException</code>. That's the strategy employed by the .NET 7 API <a href=\"https://learn.microsoft.com/en-us/dotnet/api/system.runtime.controlledexecution.run\" rel=\"nofollow noreferrer\"><code>ControlledExecution.Run</code></a> (<a href=\"https://github.com/dotnet/runtime/blob/v7.0.0/src/coreclr/System.Private.CoreLib/src/System/Runtime/ControlledExecution.CoreCLR.cs#L43\" rel=\"nofollow noreferrer\">source code</a>). You can find a custom 4.8-compatible implementation of this API in <a href=\"https://stackoverflow.com/questions/75087774/c-sharp-thread-or-task-stopping-a-hung-single-line-of-code/75090418#75090418\" title=\"Thread or Task (stopping a hung single line of code)\">this answer</a> (the <code>RunAbortable</code> method). It's not overly tested, so please use it at your own risk.</p>\n</li>\n</ol>\n", "tags": ["c#", "multithreading", "desktop-application", ".net-4.8"]}
{"id": "b04eb872-6a7c-4e7b-b75d-8f83666a5bb1", "text": "Q: Force 32 bits compilation in MSVC 2010 commandline A: <p>The OP targeted VS2010. <br>\nTo update a little bit and because when you agnostically google: \u201ccompile 32 bit with <code>cl.exe</code>\u201d or \u201cforce <code>cl.exe</code> compile and link 32 bit executable command line\n\u201d, is the first link on the list, I decided to add what I consider some relevant information. <br>\nI hope it helps for any other user in related platforms (e.g. Visual Studio 2022 Community) wanting to compile for 32 bit command line. <br> <br>\nQuick summary and update. <br>\nToday (e.g. Windows 11 64-bit): <code>cl.exe program.c /D &quot;WIN32&quot; /link /MACHINE:x86</code> will work assuming the environment (e.g. <code>INCLUDE</code> and <code>LIB</code>) is coherent with the build [otherwise you will get errors like \u201c<code>fatal error LNK1112: module machine type 'x86\u2019 conflicts with target machine type \u2018x64\u2019</code>\u201d (<a href=\"https://stackoverflow.com/a/2850513/20832155\">linking problem: fatal error LNK1112</a>)].</p>\n<p>In case of Visual Studio Community, if you want to build a 32 bit executable through command line, most reliable and straight way is to use one of the command prompts included for the task, for example, the one already configured for 32-bit builds (there is also the 64-bit equivalent).</p>\n<ul>\n<li>Easiest: directly fire the <strong>x86 Native Tools Command Prompt for VS 2022</strong> shell. <code>cl.exe program.c</code> will build a 32 bit executable without the necessity to provide any other flag/clarification if that is what you want.</li>\n<li>Alternative: fire <strong>Developer Command Prompt for VS 2022</strong>.\nYou can go to your working directory and set necessary variables (e.g. <code>INCLUDE</code> and <code>LIB</code>) to build your 32 (or 64) bit application using this script (mind the argument) [there are others <em>vcvars64.bat</em>, <em>vcvars32.bat</em>, etc. You can explore the folder]: <br></li>\n</ul>\n<blockquote>\n<p><code>C:\\Program Files (x86)\\Microsoft Visual Studio\\...\\VC\\Auxiliary\\Build\\vcvarsall.bat x86</code> will set environment accordingly without changing your working directory. After running the script you will remain where you were. <br>\n(e.g. <code>C:\\Program Files (x86)\\Microsoft Visual Studio\\...\\VC\\Auxiliary\\Build\\vcvarsall.bat x64</code> would set environment variables for building for 64 bit. The default).</p>\n</blockquote>\n<p>You can check if everything built well on success and also use the <code>file</code> command with your binary to see if is exactly what you expected.</p>\n", "tags": ["c", "visual-studio-2010", "32-bit", "cl"]}
{"id": "86d1ff16-c97d-4f9b-a236-9d8c4b4adbbf", "text": "Q: Reproducibility with Wonderwords package A: <p>Use <code>random.seed()</code> for this. In the question <strong><a href=\"https://stackoverflow.com/questions/11526975/set-random-seed-programwide-in-python\">Set random seed programwide in python</a></strong>, there are answer like these two:</p>\n<blockquote>\n<p>The main python module that is run should <code>import random</code> and call <code>random.seed(n)</code> - this is shared between all other imports of <code>random</code> as long as somewhere else doesn't reset the seed.</p>\n</blockquote>\n<blockquote>\n<p>In the beginning of your application call <code>random.seed(x)</code> making sure x is always the same. This will ensure the sequence of pseudo random numbers will be the same during each run of the application.</p>\n</blockquote>\n<p>You can also take my code for example:</p>\n<pre class=\"lang-py prettyprint-override\"><code>import random\nfrom wonderwords import RandomWord\n\n# Set the seed for the random module\nrandom.seed(42)  # You can choose any integer here\n\n# Now, when you use RandomWord, it will use the seeded random generator\nr = RandomWord()\n\n# Example usage:\nprint(&quot;First run:&quot;)\nprint(r.word())\nprint(r.sentence())\n\nprint(&quot;\\nSecond run with the same seed:&quot;)\nrandom.seed(42)  # Reset the seed for reproducibility\nr = RandomWord()\nprint(r.word())\nprint(r.sentence())\n\nprint(&quot;\\nThird run with a different seed:&quot;)\nrandom.seed(123) # A different seed\nr = RandomWord()\nprint(r.word())\nprint(r.sentence())\n</code></pre>\n", "tags": ["python", "random"]}
{"id": "bff76383-5995-4a86-9710-b9d28e5d9584", "text": "Q: How can I auto-elevate my batch file, so that it requests from UAC administrator rights if required? A: <p>I edited <a href=\"https://stackoverflow.com/a/12264592\">original Matt solution</a>:</p>\n<pre><code>@echo off &amp; cd /d &quot;%~dp0&quot;\nchcp 1251 &gt;nul\nREM :::::::::::::::::::::::::::::::::::::::::\nREM Elevate.cmd - Freedom edition\nREM Automatically check &amp; get admin rights\nREM See &quot;https://stackoverflow.com/a/79585058&quot; for description\nREM :::::::::::::::::::::::::::::::::::::::::\n \n ECHO.\n ECHO =============================\n ECHO Running Admin shell\n ECHO =============================\n ECHO.\n\n for %%k in (%0) do set batchName=%%~nk\n set &quot;vbsGetPrivileges=%temp%\\OEgetPriv_%batchName%.vbs&quot;\n\n:checkPrivileges\n  whoami /groups /nh | find &quot;S-1-16-12288&quot; &gt; nul\n  if not '%errorlevel%'=='0' goto getPrivileges\n  net session 1&gt;nul 2&gt;NUL\n  if '%errorlevel%'=='0' goto gotPrivileges\n\n:getPrivileges\n  ECHO **************************************\n  ECHO Invoking UAC for Privilege Escalation\n  ECHO **************************************\n \n  ECHO CreateObject(&quot;Shell.Application&quot;).ShellExecute &quot;%SystemRoot%\\System32\\cmd.exe&quot;, &quot;/c&quot;&quot;%~dpnx0&quot;&quot;&quot;, &quot;&quot;, &quot;runas&quot;, 1 &gt;&quot;%vbsGetPrivileges%&quot;\n  ECHO CreateObject(&quot;Scripting.FileSystemObject&quot;).DeleteFile &quot;%vbsGetPrivileges%&quot;&gt;&gt;&quot;%vbsGetPrivileges%&quot;\n\n &quot;%SystemRoot%\\System32\\WScript.exe&quot; &quot;%vbsGetPrivileges%&quot;\n exit\n\n:gotPrivileges\nREM :::::::::::::::::::::::::\nREM START\nREM :::::::::::::::::::::::::\nREM Run shell as admin - put your code below as you like\n</code></pre>\n<p>Firstly there was a problem with using the script in the middle of if/else statements because of comments with colons instead of REMs, they didn't work well and the script was crashing. I didn't try to rewrite it at the time and it was Matt who understood that this is because of colons which were to be replaced by REMs, I just reported the bug without the proper solution (it was somewhat working if you remove empty lines as I suggested but of course it was crunchy and imperfect). Also about the same time echo off didn't work if you don't put it at the top of the script (which I did and Matt did the same). Time passed, but I always continued to use the script. Now I wanted to rewrite the script fully because I actively use it with my bigger project (you can find it on my GitHub if you search for it), and we don't always agree with everything.</p>\n<p>The original script is large and uses a lot of technic. I always appreciate the short and understandble coding, each line should be there because of the clear reason. If there are a lot of variables which you don't have to use, or other things, the result is becoming too bulky. In the middle of simplification I fixed another bug - if you cancel UAC elevation, the script will remain in the temp folder, and will only be deleted upon successful elevation. It is no longer the case and I'm proud that I both found and fixed this bug. Now Matt may or may not agree with everything I said, but I probably will stick to my custom version to not force the design choices. For example original script uses shifts but I don't understand why you have to use it, I don't see the clear functional reason. I reduced the size of the script from 2178 to 1315 bytes, from 66 to 39 lines, made it more functional, and did a lot of testing and bugfixes.</p>\n<p>I use chcp to always support cyrillic, because original batch doesn't do it, but you may set any other chcp to support for example Latin special characters.</p>\n<p>Even shorter version without any variables and ASCII graphics is possible, but at this point it starts to lose some magic and information (for example about me the coauthor of this script, and its whole history), I created it and decided that I don't want to encourage its use, as it will become no different than any other elevation method, so it felt a bit disrespectful.</p>\n", "tags": ["windows", "batch-file", "uac", "windows-11", "elevated-privileges"]}
{"id": "8239db1c-6090-4419-b04c-37c9c5201846", "text": "Q: DiffProtect: How to fix &quot;No module named &#39;numpy.lib.function_base&#39;&quot; when loading PyTorch Lightning model from 2023 checkpoint in Google Colab? A: <blockquote>\n<p>How can I successfully load this old checkpoint in a modern Google Colab environment?</p>\n</blockquote>\n<p>You're asking the wrong question.</p>\n<p>At a high level, you wish to work with an unsupported ancient\nproject and its data, so you're seeking ways to accomplish that.\nThere's at least two:</p>\n<ol>\n<li>Set the controls of the Way Back machine to a little more than two years ago, and conduct all your work as if it's 2023.</li>\n<li>Go back in time to <strong>load</strong> the binary checkpoint data, <strong>export</strong> it in .CSV or other portable format, and then work on porting the ancient project to use modern deps.</li>\n</ol>\n<p>As an orthogonal issue, you can do some or all of this work on your laptop, on a linux server or docker image, and/or on Colab, whichever you find most effective and convenient.</p>\n<p>I recommend using the\n<a href=\"https://docs.astral.sh/uv/getting-started/installation\" rel=\"nofollow noreferrer\">uv</a>\npackage manager to obtain ancient interpreter and libraries.\nThe project didn't use it, but <code>uv</code> supports rapid experimentation with\ndifferent combinations of old libraries, much faster than <code>pip</code> would.</p>\n<p>I recommend following approach #2: exporting data and then updating libraries.</p>\n<blockquote>\n<p>I need a solution that:</p>\n<ul>\n<li>Works in Google Colab (2025 environment)</li>\n<li>Loads the 2023-era PyTorch Lightning checkpoint</li>\n</ul>\n</blockquote>\n<p>The portable data export of approach #2 satisfies those requirements.</p>\n<hr />\n<p>Having accomplished your goals, please post an\n<a href=\"https://stackoverflow.com/help/self-answer\">Answer</a>\nhere that mentions your forked repo, and/or submit a PR upstream.</p>\n", "tags": ["python", "pytorch", "pytorch-lightning", "google-colab"]}
{"id": "93811632-ba90-42a4-a8cc-cb1d55e2c2c0", "text": "Q: RISC-V L1 Cache Design: Combinational vs. Sequential Logic for Write-Hit Handling A: <ol>\n<li><p>This is a performance issue, It depends on what is downstream of the generated combinational signal, the clock rate, and the technology family selected and its speed grade.  If you need low latency combinatinal logic output to obtain a needed behavior, and the entire design meets its timing constraints at speed then you are ok.</p>\n<p>If you are designing an IP with the intent to be used by others in a wide range of applications, then it is a best practice to register/re-time all of the IO rather than having combinational paths across the module boundary.</p>\n</li>\n<li><p>This is a somewhat incomplete statement.</p>\n<pre><code>wdata_cache[block_offset] = data_cpu;\n</code></pre>\n<p>This infers a write only memory which does nothing; show the read side.  Is the read side synchronous?  A memory can't be strictly combinational because it will not hold its value.  So you are going to have one clock delay to have any kind of memory (except a ROM).  That being said a common RAM style is synchronous write/asynchronous read.  One possible way out of this is to have the memory operating at a higher clock rate so that the read side is available before the next clock edge of the slow clock.  This adds the complexity of clock domain crossing which is not an easy topic.  Xilinx document UG901 shows some coding styles for RAM inference.</p>\n<p>Generally you are talking about a memory and a controller and showing all combinational logic, which does not make much sense.  Controllers usually have feedback (like a state machine) but it has to be feedback around regs otherwise you have a latch.</p>\n<p>It would help to show more of the design.  Usually Stack Overflow commenters request a minimal reproducible example that will simulate in a testbench.  This post is well below that standard.</p>\n<p>It also seems like you are starting from scratch.  Maybe search for similar design to use as a template rather than re-inventing the wheel.</p>\n</li>\n</ol>\n", "tags": ["caching", "verilog", "cpu-architecture", "system-verilog", "riscv"]}
