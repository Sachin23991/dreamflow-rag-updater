name: Hourly RAG Update Pipeline

on:
  schedule:
    - cron: "0 * * * *"   # Runs every hour
  workflow_dispatch:     # Allows manual trigger

# ✅ REQUIRED: Grant write permission so GitHub Actions can push
permissions:
  contents: write

jobs:
  rag-update:
    runs-on: ubuntu-latest

    steps:
      # ✅ Step 1: Checkout GitHub Repo with Auth
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # ✅ Step 2: Setup Python
      - name: Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # ✅ Step 3: Install Dependencies
      - name: Install Python Dependencies
        run: |
          pip install --upgrade pip
          pip install requests huggingface_hub

      # ✅ Step 4: Set Hugging Face Token (Secret)
      - name: Set Hugging Face Auth
        run: |
          echo "HF_TOKEN=${{ secrets.HF_TOKEN }}" >> $GITHUB_ENV

      # ✅ Step 5: Run Your Complete Pipeline
      - name: Run RAG Update Pipeline
        env:
          HUGGINGFACE_HUB_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python main.py

      # ✅ Step 6: Auto Commit & Push (Safe & Error-Free)
      - name: Auto Commit & Push
        run: |
          git config --global user.name "Sachin23991"
          git config --global user.email "sachinraosahab7@gmail.com"

          git status
          git add .

          if git diff --cached --quiet; then
            echo "✅ No changes to commit"
          else
            git commit -m "Hourly RAG Update - $(date -u)"
            git push
          fi
