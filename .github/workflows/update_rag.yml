name: Daily RAG Update ğŸ¤–
on:
  # Runs daily at 23:40 UTC
  schedule:
    - cron: "40 23 * * *"
  # Allows manual triggering from the GitHub UI
  workflow_dispatch:

jobs:
  update-rag:
    # Use the latest Ubuntu runner
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“ Checkout repo
        # Checks out your repository code so the workflow can access it
        uses: actions/checkout@v4

      - name: âš™ï¸ Install dependencies
        run: |
          # Upgrade pip and install required libraries
          python -m pip install --upgrade pip
          pip install sentence-transformers faiss-cpu pandas huggingface_hub

      - name: â¬‡ï¸ Download latest train.jsonl from HF dataset
        run: |
          # Use wget to download the latest data file
          wget -O train.jsonl "https://huggingface.co/datasets/Sachin21112004/DreamFlow-AI-Data/resolve/main/train.jsonl"

      - name: ğŸš€ Run RAG update script
        run: |
          # Executes your local script to process data and create/update rag_storage
          python rag_update.py

      - name: â¬†ï¸ Upload rag_storage to Hugging Face model repo
        # Set the environment variable for the secret token
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        # FIX: The entire script is enclosed in single quotes to resolve the YAML syntax error.
        run: 'python - <<''PY''
from huggingface_hub import HfApi
import os

api = HfApi()

api.upload_folder(
    repo_id="Sachin21112004/carrerflow-ai",
    folder_path="rag_storage",
    path_in_repo="rag_storage",
    token=os.environ["HF_TOKEN"],
    commit_message="Daily updated RAG knowledge"
)

print("âœ” Upload complete")
'
